<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>WebCtp Demo</title>
  <link rel="stylesheet" href="purecss@3.0.0_build_pure.css">
  <style>
      body {
          margin: 0;
          padding: 0;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
      }

      .content-upper {
          flex: 1;
          background-color: lightblue;
          display: flex;
          justify-content: center;
          align-items: center;
          /*height: 50vh; !* 设置为视口高度的一半，可根据实际需求调整 *!*/
          /*flex-direction: column;*/
          /*overflow-y: auto;*/
          /*position: relative;*/
      }

      .button-secondary {
          background: rgb(66, 184, 221); /* this is a light blue */
      }

      .button-error {
          background: rgb(202, 60, 60); /* this is a maroon */
      }

      .button-warning {
          background: rgb(223, 117, 20); /* this is an orange */
      }

      .button-success {
          background: rgb(28, 184, 65); /* this is a green */
      }

      #futures-table {
          position: fixed;
          top: 0;
          border-collapse: collapse;
          width: 100%;
          /*height: 100%;*/
      }

      table, th, td {
          border: 1px solid black;

      }

      .selected {
          background-color: lightgray;
          color: black;
      }

      th, td {
          padding: 8px;
          text-align: center;
      }

      .content-lower {
          flex: 1;
          display: flex;
          /*height: 50vh; !* 设置为视口高度的一半，可根据实际需求调整 *!*/
      }

      .content-lower-left {
          flex: 1 1 80%;
          background-color: lightyellow;
          padding: 10px;
          display: flex;
          flex-direction: column;
      }

      .pure-tab {
          margin-top: 10px;
      }

      .pure-tab button {
          background-color: #f1f1f1;
          border: 1px solid #ccc;
          color: inherit;
          cursor: pointer;
          padding: 10px 15px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          transition: background-color 0.3s;
      }

      .pure-tab button:hover {
          background-color: #ddd;
      }

      .pure-tab button.active {
          background-color: #ccc;
      }

      .pure-tab-content {
          border: 1px solid #ccc;
          padding: 10px;
          background-color: white;
          display: none;

          /* 添加以下样式确保tab页内容不影响布局 */
          position: absolute;
          overflow: auto;
          max-height: 45%;
          width: 75%;

          /* 新增样式，设置为透明且不占据空间（只在隐藏时生效） */
          visibility: hidden;
          opacity: 0;
          z-index: 1;
      }

      .pure-tab-content.active {
          /* 当tab页处于激活状态时，恢复正常显示和交互 */
          visibility: visible;
          opacity: 1;
          z-index: 2;
      }

      .pure-tab-content table {
          width: 100%;
          position: sticky;
          top: 0;
          background-color: white;
      }

      .content-lower-right {
          flex: 1 1 20%;
          background-color: #d2d5e0;
          padding: 10px;
      }

      footer {
          background-color: gray;
          color: white;
          text-align: center;
          padding: 10px;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
      }
  </style>
</head>

<body>
<div id="md" class="content-upper">
  <!--  <div class="md-content">-->
  <table id="futures-table" class="pure-table pure-table-bordered" v-scope>
    <thead>
    <tr>
      <th>合约代码</th>
      <!--            <th>交易所代码</th>-->
      <th>最新价</th>
      <th>今开盘</th>
      <th>最高价</th>
      <th>最低价</th>
      <th>昨收盘</th>
      <th>昨结算价</th>
      <th>昨持仓量</th>
      <th>数量</th>
      <th>持仓量</th>
      <th>成交金额</th>
      <th>今收盘</th>
      <th>今结算价</th>
      <th>交易日</th>
      <th>时间</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="(row, rowIndex) in mdData.quotRows" :key="rowIndex" onclick="quotSelect(this)">
      <td>{{ row.InstrumentID }}</td>
      <!--            <td>{{ row.ExchangeID }}</td>-->
      <td>{{ row.LastPrice }}</td>
      <td>{{ row.OpenPrice }}</td>
      <td>{{ row.HighestPrice }}</td>
      <td>{{ row.LowestPrice }}</td>
      <td>{{ row.PreClosePrice }}</td>
      <td>{{ row.PreSettlementPrice }}</td>
      <td>{{ row.PreOpenInterest }}</td>
      <td>{{ row.volume }}</td>
      <td>{{ row.OpenInterest }}</td>
      <td>{{ row.Turnover }}</td>
      <td>{{ row.ClosePrice }}</td>
      <td>{{ row.SettlementPrice }}</td>
      <td>{{ row.TradingDay }}</td>
      <td>{{ row.UpdateTime }}</td>
      <td>
        <button style="font-size: 60%" class="pure-button button-warning" onclick="unsub(this)">退订</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>
<!--</div>-->
<div id="td" class="content-lower">

  <div class="content-lower-left">
    <div id="tabOrder" class="pure-tab-content">
      <table id="order-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>合约</th>
          <th>交易所</th>
          <th>买卖</th>
          <th>开平</th>
          <th>手数</th>
          <th>报单价格</th>
          <th>报单状态</th>
          <th>报单日期</th>
          <th>报单时间</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.orderRows" :key="rowIndex" onclick="orderSelect(this)">
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.ExchangeID }}</td>
          <td>{{ row.Direction }}</td>
          <td>{{ row.CombOffsetFlag }}</td>
          <td>{{ row.VolumeTotalOriginal }}</td>
          <td>{{ row.LimitPrice }}</td>
          <td>{{ row.OrderStatus }}</td>
          <td>{{ row.InsertDate }}</td>
          <td>{{ row.InsertTime }}</td>
          <td>
            <button style="font-size: 60%" class="pure-button button-secondary" onclick="cancel(this);">撤单</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="tabTrade" class="pure-tab-content">
      <table id="trade-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>合约</th>
          <th>交易所</th>
          <th>买卖</th>
          <th>开平</th>
          <th>手数</th>
          <th>成交价格</th>
          <th>成交编号</th>
          <th>报单编号</th>
          <th>成交日期</th>
          <th>成交时间</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.tradeRows" :key="rowIndex" onclick="tradeSelect(this)">
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.ExchangeID }}</td>
          <td>{{ row.Direction }}</td>
          <td>{{ row.OffsetFlag }}</td>
          <td>{{ row.Volume }}</td>
          <td>{{ row.Price }}</td>
          <td>{{ row.TradeID }}</td>
          <td>{{ row.OrderSysID }}</td>
          <td>{{ row.TradeDate }}</td>
          <td>{{ row.TradeTime }}</td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="tabPosi" class="pure-tab-content">
      <table id="posi-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>合约</th>
          <th>买卖</th>
          <th>今日持仓</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.positionRows" :key="rowIndex" onclick="posiSelect(this)">
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.PosiDirection }}</td>
          <td>{{ row.Position }}</td>
        </tr>
        </tbody>
      </table>
    </div>
    <div id="tabInst" class="pure-tab-content">
      <table id="instr-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>合约ID</th>
          <th>合约名称</th>
          <th>交易所</th>
          <th>合约乘数</th>
          <th>产品类型</th>
          <th>产品ID</th>
          <th>最小变动价位</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.instrumentRows" :key="rowIndex" onclick="instrSelect(this)">
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.InstrumentName }}</td>
          <td>{{ row.ExchangeID }}</td>
          <td>{{ row.VolumeMultiple }}</td>
          <td>{{ row.ProductClass }}</td>
          <td>{{ row.ProductID }}</td>
          <td>{{ row.PriceTick }}</td>
          <td>
            <button style="font-size: 60%" class="pure-button button-success" onclick="sub(this);">订阅</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 添加一个用于撑开空间的空div，使其按钮位于最底部 -->
    <div style="flex-grow: 1;"></div>
    <!--    </div>-->
    <!--    <div id="pure-content">-->
    <div class="pure-tab">
      <button class="pure-button pure-tab-button" onclick="openTab(event, 'tabOrder')" id="defaultOpen">委托单</button>
      <button class="pure-button pure-tab-button" onclick="openTab(event, 'tabTrade')">成交记录</button>
      <button class="pure-button pure-tab-button" onclick="openTab(event, 'tabPosi')">持仓</button>
      <button class="pure-button pure-tab-button" onclick="openTab(event, 'tabInst')">合约</button>
    </div>

  </div>
  <div class="content-lower-right">
  </div>
</div>
<!--<footer>-->
<!--  这是固定页脚，显示一些版权信息、联系方式等。-->
<!--</footer>-->

<script src='petite-vue@0.4.1_dist_petite-vue.iife.js'></script>
<script>
  function log(msg) {
    console.log((new Date()).toLocaleString(), ...Array.from(arguments));
  }

  const mdData = PetiteVue.reactive({
    quotRows: [],
    isLogin: false,
  })
  const mdApp = PetiteVue.createApp({
    mdData
  }).mount('#md');

  const tdData = PetiteVue.reactive({
    orders: {},
    orderRows: [],
    trades: {},
    tradeRows: [],
    positions: {},
    positionRows: [],
    instruments: {},
    instrumentRows: [],
    exchanges: {},
    tradingAccount: {},
    isLogin: false,
  })
  const tdApp = PetiteVue.createApp({
    tdData
  }).mount('#td');


  const mdAddr = 'ws://localhost:8080/md/';
  const tdAddr = 'ws://localhost:8080/td/';
  const brokerID = '9999';
  const investorID = '';

  // market channel
  const sock_md = new WebSocket(mdAddr);
  sock_md.onopen = function (event) {
    log('Market channel connected.', mdAddr);
    loginMd();
  };
  sock_md.onclose = function (event) {
    log('Market channel closed.');
  };
  sock_md.onerror = function (event) {
    log('Market channel error:', event);
  };
  sock_md.onmessage = function (event) {
    let data = JSON.parse(event.data)
    // log('Market msg:', data['MsgType']);
    // console.log(data);
    switch (data['MsgType']) {
      case 'RspUserLogin':
        mdRspUserLogin(data)
        break;
      case 'RspSubscribeMarketData':
        RspSubscribeMarketData(data);
        break;
      case 'RspUnSubMarketData':
        RspUnSubscribeMarketData(data);
        break;
      case 'RtnDepthMarketData':
        RtnDepthMarketData(data);
        break;
    }
  };

  function req_md(data) {
    log('Market request:', data['MsgType']);
    // console.log(data);
    sock_md.send(JSON.stringify(data));
  }

  function parseRspInfo(name, RspInfo) {
    if (RspInfo !== null && RspInfo['ErrorID'] !== 0) {
      console.log(name, 'Fail', RspInfo['ErrorMsg']);
      return false;
    } else {
      console.log(name, 'Success');
      return true;
    }
  }

  function loginMd() {
    req_md({"MsgType": "ReqUserLogin", "ReqUserLogin": {"UserID": "", "Password": ""}});
  }

  function mdRspUserLogin(data) {
    if (parseRspInfo('行情登录', data['RspInfo']) === true) {
      mdData.isLogin = true;
      SubscribeMarketData(['au2412', 'cu2412', 'c2501', 'l2501', 'p2501', 'v2501']);
    }
  }

  function SubscribeMarketData(instruments) {
    log('订阅行情 ' + instruments);
    req_md({"MsgType": "SubscribeMarketData", "InstrumentID": instruments})
  }

  function RspSubscribeMarketData(data) {
    //  todo 无订阅应答
    console.log(data);
    if (parseRspInfo('行情订阅', data['RspInfo']) === true) {
      console.log(data['SpecificInstrument']);
    }
  }

  function UnSubscribeMarketData(instruments) {
    req_md({"MsgType": "UnSubscribeMarketData", "InstrumentID": instruments})
  }

  function RspUnSubscribeMarketData(data) {
    console.log(data);
    if (parseRspInfo('取消行情订阅', data['RspInfo']) === true) {
      let instrumentID = data['SpecificInstrument']['InstrumentID'];
      log('退订行情 ' + instrumentID);
      for (let i = 0; i < mdData.quotRows.length; i++) {
        if (mdData.quotRows[i]['InstrumentID'] === instrumentID) {
          mdData.quotRows.splice(i, 1);
          i--;
          break;
        }
      }
    }
  }

  function RtnDepthMarketData(data) {
    let quot = data['DepthMarketData']
    const index = mdData.quotRows.findIndex(row => row.InstrumentID === quot['InstrumentID']);
    if (index !== -1) {
      for (let key in mdData.quotRows[index]) {
        mdData.quotRows[index][key] = quot[key];
      }
    } else {
      mdData.quotRows.push(quot);
    }
  }

  // trade channel
  const sock_td = new WebSocket(tdAddr);
  sock_td.onopen = function (event) {
    log('trade channel connected.', tdAddr);
    loginTd('226485', 'sWJedore20@$0807');
  };
  sock_td.onclose = function (event) {
    log('trade channel closed.');
  };
  sock_td.onerror = function (event) {
    log('trade channel error:', event);
  };
  sock_td.onmessage = function (event) {
    let data = JSON.parse(event.data)
    // log('trade msg:', data['MsgType']);
    // console.log(data);
    switch (data['MsgType']) {
      case 'RspUserLogin':
        tdRspUserLogin(data)
        break;
      case 'RspQryTrade':
        RspQryTrade(data);
        break;
      case 'RspQryInvestorPosition':
        RspQryInvestorPosition(data);
        break;
      case 'RspQryTradingAccount':
        RspQryTradingAccount(data);
        break;
      case 'RspQryInstrument':
        RspQryInstrument(data);
        break;
      case 'RspQryOrder':
        RspQryOrder(data);
        break;
      case 'RspQryExchange':
        RspQryExchange(data);
        break;
      case 'RspOrderInsert':
        RspOrderInsert(data);
        break;
      case 'RspOrderAction':
        RspOrderAction(data);
        break;
      case 'RtnOrder':
        RtnOrder(data);
        break;
      case 'ErrRtnOrderAction':
        ErrRtnOrderAction(data);
        break;
    }
  };

  function req_td(data) {
    log('trade request:', data['MsgType']);
    // console.log(data);
    data['RequestID'] = 0;
    sock_td.send(JSON.stringify(data));
  }

  function loginTd(userid, password) {
    req_td({"MsgType": "ReqUserLogin", "ReqUserLogin": {"UserID": userid, "Password": password}});
  }

  // todo 参数有误时，返回 ReqUserLogin MsgType
  function tdRspUserLogin(data) {
    if (parseRspInfo('交易登录', data['RspInfo']) === true) {
      tdData.isLogin = true;
      // console.log(data)
      ReqQryTradingAccount();
    }
  }

  function ReqQryTradingAccount() {
    req_td({
      "MsgType": "ReqQryTradingAccount",
      "QryTradingAccount": {
        "BrokerID": brokerID,
        "InvestorID": investorID
      },
    });
  }

  function RspQryTradingAccount(data) {
    if (parseRspInfo('查询资金账户', data['RspInfo']) === true) {
      // console.log(data);
      tdData.tradingAccount = data['TradingAccount'];
      if (data['IsLast'] === true) {
        ReqQryExchange('');
      }
    }
  }

  function ReqQryExchange(exchangeID) {
    req_td({
      "MsgType": "ReqQryExchange",
      "QryExchange": {
        "ExchangeID": exchangeID
      },
    });
  }

  function RspQryExchange(data) {
    if (parseRspInfo('查询交易所', data['RspInfo']) === true) {
      console.log(data);
      let exchange = data['Exchange'];
      if (exchange !== null) {
        tdData.exchanges[exchange['ExchangeID']] = exchange;
      }
      if (data['IsLast'] === true) {
        ReqQryOrder('');
      }
    }

  }

  async function ReqQryInstrument(exchangeID, productID, instrumentID) {
    await sleep(2000);
    req_td({
      "MsgType": "ReqQryInstrument",
      "QryInstrument": {
        "ExchangeID": exchangeID,
        "InstrumentID": instrumentID,
        "ProductID": productID
      },
    });
  }

  function RspQryInstrument(data) {
    if (parseRspInfo('查询合约', data['RspInfo']) === true) {
      // console.log(data);
      let instrument = data['Instrument'];
      if (instrument !== null) {
        if (instrument['InstrumentID'] !== null && instrument['ProductClass'] === '1') {
          tdData.instruments[instrument['InstrumentID']] = instrument;
          tdData.instrumentRows.push(instrument);
        }
      }
      if (data['IsLast'] === true) {
        // tdData.instrumentRows = Object.values(tdData.instruments);
      }
    } else {
      // test();
      // ReqQryInstrument('', '', '');
    }
  }

  function ReqQryOrder(instrumentID) {
    req_td({
      "MsgType": "ReqQryOrder",
      "QryOrder": {
        "InvestorID": investorID,
        "InstrumentID": instrumentID,
      },
    });
  }

  function RspQryOrder(data) {
    if (parseRspInfo('查询报单', data['RspInfo']) === true) {
      // console.log(data);
      let order = data['Order'];
      if (order !== null) {
        let key = order['ExchangeID'] + order['OrderSysID'];
        tdData.orders[key] = order;
      }
      if (data['IsLast'] === true) {
        // todo
        tdData.orderRows = Object.values(tdData.orders);
        ReqQryTrade('');
      }
    }
  }

  function ReqQryTrade(exchangeID) {
    req_td({
      "MsgType": "ReqQryTrade",
      "QryTrade": {
        "BrokerID": brokerID,
        "InvestorID": investorID,
        "ExchangeID": exchangeID
      },
    });
  }

  function RspQryTrade(data) {
    if (parseRspInfo('查询成交', data['RspInfo']) === true) {
      console.log(data);
      let trade = data['Trade'];
      if (trade !== null) {
        let key = trade['ExchangeID'] + '.' + trade['TradeID'] + '.' + trade['OrderSysID'];
        tdData.trades[key] = trade;
      }

      if (data['IsLast'] === true) {
        // todo
        tdData.tradeRows = Object.values(tdData.trades);
        ReqQryInvestorPosition('', '');
      }
    }
  }

  function ReqQryInvestorPosition(investorID, exchangeID) {
    req_td({
      "MsgType": "ReqQryInvestorPosition",
      "QryInvestorPosition": {
        "BrokerID": "9999",
        "InvestorID": investorID,
        "ExchangeID": exchangeID
      },
    });

  }

  function RspQryInvestorPosition(data) {
    if (parseRspInfo('查询持仓', data['RspInfo']) === true) {
      console.log(data);
      let position = data['InvestorPosition'];
      if (position !== null) {
        tdData.positions[position['InstrumentID']] = position;
      }
      if (data['IsLast'] === true) {
        tdData.positionRows = Object.values(tdData.positions);

        // test();

        ReqQryInstrument('', '', '');
      }
    }
  }

  function ReqOrderInsert() {

  }

  function RspOrderInsert(data) {
    if (parseRspInfo('订单录入', data['RspInfo']) === true) {

    }
  }

  function ReqOrderAction() {

  }

  function RspOrderAction(data) {
    if (parseRspInfo('订单撤销', data['RspInfo']) === true) {
    }
  }

  function RtnOrder(data) {

  }

  function ErrRtnOrderAction() {

  }

  // 定义打开tab页的函数
  function openTab(evt, tabName) {
    var i, pureTabContent, pureTabButton;

    // 隐藏所有tab内容，并设置为不影响布局的样式
    pureTabContent = document.getElementsByClassName("pure-tab-content");
    for (i = 0; i < pureTabContent.length; i++) {
      pureTabContent[i].style.display = "none";
      pureTabContent[i].style.visibility = "hidden";
      pureTabContent[i].style.opacity = "0";
    }

    // 移除所有tab按钮的激活状态
    pureTabButton = document.getElementsByClassName("pure-tab-button");
    for (i = 0; i < pureTabButton.length; i++) {
      pureTabButton[i].style.backgroundColor = "#f1f1f1";
      pureTabButton[i].classList.remove("active");
    }

    // 显示当前选中的tab内容并设置为正常显示和交互的样式
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName).style.visibility = "visible";
    document.getElementById(tabName).style.opacity = "1";

    // 设置当前tab按钮为激活状态
    evt.currentTarget.style.backgroundColor = "#ccc";
    evt.currentTarget.classList.add("active");
  }

  // 打开默认tab页
  document.getElementById("defaultOpen").click();

  // 创建一个返回Promise的函数来模拟sleep
  const sleep = (ms) => {
    return new Promise((resolve) => {
      setTimeout(resolve, ms);
    });
  };

  async function test() {
    console.log('开始');

    await sleep(3000);

    console.log('等待一段时间后执行，这里模拟了sleep效果');
  }

  function sub(button) {
    let row = button.closest('tr');
    let firstColumnCell = row.querySelector('td:first-child');
    let firstColumnContent = firstColumnCell.textContent;
    SubscribeMarketData([firstColumnContent]);
  }

  function unsub(button) {
    let row = button.closest('tr');
    let firstColumnCell = row.querySelector('td:first-child');
    let firstColumnContent = firstColumnCell.textContent;
    UnSubscribeMarketData([firstColumnContent]);
  }

  function cancel(button) {
    let row = button.closest('tr');
    console.log('撤单');
    // let firstColumnCell = row.querySelector('td:first-child');
    // let firstColumnContent = firstColumnCell.textContent;
    // UnSubscribeMarketData([firstColumnContent]);
  }

  function quotSelect(row) {
    let allRows = document.getElementById('futures-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function orderSelect(row) {
    let allRows = document.getElementById('order-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function tradeSelect(row) {
    let allRows = document.getElementById('trade-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function posiSelect(row) {
    let allRows = document.getElementById('posi-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function instrSelect(row) {
    let allRows = document.getElementById('instr-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }


</script>
</body>

</html>