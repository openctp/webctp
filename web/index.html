<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>WebCtp Demo</title>
  <link rel="stylesheet" href="purecss@3.0.0_build_pure.css">
  <style>

      .button-secondary {
          background: rgb(66, 184, 221); /* this is a light blue */
      }

      .button-error {
          background: rgb(202, 60, 60); /* this is a maroon */
      }

      .button-warning {
          background: rgb(223, 117, 20); /* this is an orange */
      }

      .button-success {
          background: rgb(28, 184, 65); /* this is a green */
      }

      .button-small {
          font-size: 85%;
      }

      .selected {
          background-color: lightgray;
          color: black;
      }

      th, td {
          text-align: right;
      }

      body {
          margin: 0;
          padding: 0;
          height: 100vh;
          display: flex;
          flex-direction: column;
          background-color: lightyellow;
          font-size: 15px;
      }

      .content-upper {
          flex: 1;
          top: 0;
          background-color: lightyellow;
          display: flex;
          /*justify-content: center;*/
          /*align-items: center;*/
          flex-direction: column;
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
          overflow-y: scroll;
      }

      .content-lower {
          flex: 1;
          display: flex;
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
      }

      .content-foot {
          /*flex: 3;*/
          /*display: flex;*/
          height: 30px;
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
      }

      #login {
          justify-content: center;
          align-items: center;
          width: 100%;
          height: 100%;
      }

      #account {
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
      }

      #futures-table {
          top: 0;
          border-collapse: collapse;
          width: 100%;
          table-layout: fixed; /* 避免列宽被内容撑开 */
      }

      #futures-table thead tr {
          background-color: lightgray;
      }

      thead tr {
          position: sticky;
          top: 0;
          z-index: 10;
      }

      /*结合固定列宽度*/
      #futures-table td {
          overflow: hidden;
          white-space: wrap;
          text-overflow: ellipsis;
      }

      .content-lower-left {
          flex: 1 1 65%;
          background-color: lightyellow;
          display: flex;
          flex-direction: column;
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
      }

      .content-lower-right {
          flex: 1 1 23%;
          background-color: lightyellow;
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */

          display: flex;
          flex-direction: column;
      }

      .content-lower-log {
          flex: 1 1 12%;
          /*background-color: lightyellow;*/
          border: 1px solid black; /* 用于显示div的边界，方便查看效果 */
          font-size: 13px;

          display: flex;
          flex-direction: column;
      }

      #log-wrapper {
          flex: 1;
          /*display: none;*/
          max-height: 46%;
          width: 12%;
          position: absolute;
          overflow-y: scroll;
      }

      #log-table {
          width: 100%;
          position: sticky;
          top: 0;
      }

      #log-table thead th {
          text-align: center;
      }

      #log-table thead {
          background-color: transparent;
      }

      .pure-tab {
          margin-top: 10px;
      }

      .pure-tab-content {
          border: 1px solid #ccc;
          /*padding: 10px;*/
          /*background-color: white;*/
          display: none;

          /* 添加以下样式确保tab页内容不影响布局 */
          position: absolute;
          overflow-y: auto;
          max-height: 40%;
          width: 64.6%;

          /* 新增样式，设置为透明且不占据空间（只在隐藏时生效） */
          visibility: hidden;
          opacity: 0;
          z-index: 1;
      }

      .pure-tab-content.active {
          /* 当tab页处于激活状态时，恢复正常显示和交互 */
          visibility: visible;
          opacity: 1;
          z-index: 2;
      }

      .pure-tab-content table {
          width: 100%;
          position: sticky;
          top: 0;
      }

      .pure-tab-content table thead tr {
          background-color: lightgray;
      }

      #buy-open-button, #buy-close-button {
          color: red;
      }

      #sell-open-button, #sell-close-button {
          color: green;
      }

      table thead tr th:first-child {
          width: 15px;
          text-align: center;
      }

      table tbody tr td:first-child {
          text-align: center;
      }
  </style>
</head>

<body>
<div id="md" class="content-upper">
  <table id="futures-table" class="pure-table pure-table-bordered" v-scope>
    <thead>
    <tr>
      <th>#</th>
      <th>合约</th>
      <th>最新价</th>
      <th>买一价</th>
      <th>买一量</th>
      <th>卖一价</th>
      <th>卖一量</th>
      <th>涨停价</th>
      <th>跌停价</th>
      <!--      <th>涨跌</th>-->
      <!--      <th>涨跌幅</th>-->
      <th>成交量</th>
      <th>今开盘</th>
      <th>最高价</th>
      <th>最低价</th>
      <th>昨收盘</th>
      <th>昨结算</th>
      <th>交易日</th>
      <th>时间</th>
      <th>交易所</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="(row, rowIndex) in mdData.quotRows" :key="rowIndex" onclick="quotSelect(this)">
      <td>{{ rowIndex + 1 }}</td>
      <td>{{ row.InstrumentID }}</td>
      <td>{{ row.LastPrice }}</td>
      <td>{{ row.BidPrice1 }}</td>
      <td>{{ row.BidVolume1}}</td>
      <td>{{ row.AskPrice1 }}</td>
      <td>{{ row.AskVolume1}}</td>
      <td>{{ row.UpperLimitPrice }}</td>
      <td>{{ row.LowerLimitPrice }}</td>
      <td>{{ row.Volume }}</td>
      <td>{{ row.OpenPrice }}</td>
      <td>{{ row.HighestPrice }}</td>
      <td>{{ row.LowestPrice }}</td>
      <td>{{ row.PreClosePrice }}</td>
      <td>{{ row.PreSettlementPrice }}</td>
      <td>{{ row.TradingDay }}</td>
      <td>{{ row.UpdateTime }}</td>
      <td>{{ row.ExchangeID }}</td>
      <td>
        <button class="pure-button button-small pure-button-primary" onclick="unsub(this)">退订</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>
<div id="td" class="content-lower">
  <div class="content-lower-left">
    <div id="tabOrder" class="pure-tab-content">
      <table id="order-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>#</th>
          <th>合约</th>
          <th>买卖</th>
          <th>开平</th>
          <th>手数</th>
          <th>报单价格</th>
          <th>报单状态</th>
          <th>报单编号</th>
          <th>报单日期</th>
          <th>报单时间</th>
          <th>交易所</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.orderRows" :key="rowIndex" onclick="orderSelect(this)">
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.bs }}</td>
          <td>{{ row.oc}}</td>
          <td>{{ row.VolumeTotalOriginal }}</td>
          <td>{{ row.LimitPrice }}</td>
          <td>{{ row.StatusMsg }}</td>
          <td>{{ row.OrderSysID }}</td>
          <td>{{ row.InsertDate }}</td>
          <td>{{ row.InsertTime }}</td>
          <td>{{ row.ExchangeID }}</td>
          <td>
            <button v-if="row.StatusMsg === '未成交'" class="pure-button button-small pure-button-primary"
                    onclick="cancelOrder(this);">撤单
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="tabTrade" class="pure-tab-content">
      <table id="trade-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>#</th>
          <th>合约</th>
          <th>买卖</th>
          <th>开平</th>
          <th>手数</th>
          <th>成交价格</th>
          <th>成交编号</th>
          <th>报单编号</th>
          <th>成交日期</th>
          <th>成交时间</th>
          <th>交易所</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.tradeRows" :key="rowIndex" onclick="tradeSelect(this)">
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.bs }}</td>
          <td>{{ row.oc }}</td>
          <td>{{ row.Volume }}</td>
          <td>{{ row.Price }}</td>
          <td>{{ row.TradeID }}</td>
          <td>{{ row.OrderSysID }}</td>
          <td>{{ row.TradeDate }}</td>
          <td>{{ row.TradeTime }}</td>
          <td>{{ row.ExchangeID }}</td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="tabPosi" class="pure-tab-content">
      <table id="posi-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>#</th>
          <th>合约</th>
          <th>多/空</th>
          <th>今日持仓</th>
          <th>上日持仓</th>
          <th>平仓量</th>
          <th>多头冻结</th>
          <th>空头冻结</th>
          <th>交易日</th>
          <th>交易所</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.positionRows" :key="rowIndex" onclick="posiSelect(this)">
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.sl }}</td>
          <td>{{ row.Position }}</td>
          <td>{{ row.YdPosition }}</td>
          <td>{{ row.CloseVolume }}</td>
          <td>{{ row.LongFrozen }}</td>
          <td>{{ row.ShortFrozen }}</td>
          <td>{{ row.TradingDay }}</td>
          <td>{{ row.ExchangeID }}</td>
        </tr>
        </tbody>
      </table>
    </div>
    <div id="tabInst" class="pure-tab-content">
      <table id="instr-table" class="pure-table pure-table-bordered" v-scope>
        <thead>
        <tr>
          <th>#</th>
          <th>合约</th>
          <th>合约名称</th>
          <th>合约乘数</th>
          <th>产品类型</th>
          <th>产品ID</th>
          <th>最小变动价位</th>
          <th>交易所</th>
          <th>交易所</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(row, rowIndex) in tdData.instrumentRows" :key="rowIndex" onclick="instrSelect(this)">
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ row.InstrumentID }}</td>
          <td>{{ row.InstrumentName }}</td>
          <td>{{ row.VolumeMultiple }}</td>
          <td>{{ row.ProductClass }}</td>
          <td>{{ row.ProductID }}</td>
          <td>{{ row.PriceTick }}</td>
          <td>{{ row.ExchangeID }}</td>
          <td>{{ row.ExchangeName }}</td>
          <td>
            <button class="pure-button button-small pure-button-primary" onclick="sub(this);">订阅</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 添加一个用于撑开空间的空div，使其按钮位于最底部 -->
    <div style="flex-grow: 1;"></div>
    <!--    </div>-->
    <!--    <div id="pure-content">-->
    <div class="pure-tab">
      <button class="button-small pure-button pure-tab-button" onclick="openTab(event, 'tabOrder')" id="defaultOpen">
        委托单
      </button>
      <button class="button-small pure-button pure-tab-button" onclick="openTab(event, 'tabTrade')">成交记录</button>
      <button class="button-small pure-button pure-tab-button" onclick="openTab(event, 'tabPosi')">持仓</button>
      <button class="button-small pure-button pure-tab-button" onclick="openTab(event, 'tabInst')">合约</button>
    </div>

  </div>
  <div class="content-lower-right">
    <div id="login">
      <form class="pure-form pure-form-aligned" style="height: 100%; width: 100%" v-scope>
        <fieldset>
          <div class="pure-control-group">
            <label for="md-addr">行情通道</label>
            <input id="md-addr" type="text" class="pure-input-1-2" v-model="tdData.mdAddr">
          </div>
          <div class="pure-control-group">
            <label for="td-addr">交易通道</label>
            <input id="td-addr" type="text" class="pure-input-1-2" v-model="tdData.tdAddr">
          </div>
          <div class="pure-control-group">
            <label for="investorID">投资者ID</label>
            <input id="investorID" type="text" class="pure-input-1-2" placeholder="InvestorID"
                   v-model="tdData.investorID">
          </div>

          <div class="pure-control-group">
            <label for="password">密码</label>
            <input id="password" type="password" class="pure-input-1-2" placeholder="Password"
                   v-model="tdData.password">
          </div>

          <div class="pure-control-group">
            <label for="brokerID">Broker ID</label>
            <input id="brokerID" type="text" class="pure-input-1-2" placeholder="BrokerID" v-model="tdData.brokerID">
          </div>

          <div class="pure-controls">
            <button type="button" class="pure-button" onclick="login()">登 录</button>
          </div>
        </fieldset>
      </form>
    </div>
    <div id="account-price" hidden>
      <form class="pure-form pure-form-aligned" v-scope>
        <fieldset style="text-align: center">
          <legend style="font-weight: bold">报价板</legend>
          <div class="pure-control-group">
            <label for="exchange">交易所</label>
            <input type="text" id="exchange" v-model="tdData.curInstrument.ExchangeID" value="">
          </div>

          <div class="pure-control-group">
            <label for="contract-input">合约</label>
            <input type="text" id="contract-input" class="contract-input" placeholder="请输入合约"
                   v-model="tdData.curInstrument.InstrumentID">
          </div>
          <div class="pure-control-group">
            <label for="contract-price">价格</label>
            <input type="number" id="contract-price" class="price-display" placeholder="请输入价格" min="0" step="0.01"
                   v-model="tdData.curInstrument.Price">
          </div>
          <div class="pure-control-group">
            <label for="contract-volume">数量</label>
            <input type="number" id="contract-volume" class="price-display" placeholder="请输入数量" value="1" min="1"
                   v-model="tdData.curInstrument.Volume">
          </div>

          <div class="pure-control-group">
            <label for="contract-input"></label>
            <button type="button" id="buy-open-button" class="pure-u-1-5 pure-button button-small"
                    onclick="buyOpen()">
              买开
            </button>
            <button type="button" id="buy-close-button" class="pure-u-1-5 pure-button button-small"
                    onclick="buyClose()">买平
            </button>
          </div>
          <div class="pure-control-group">
            <label for="contract-input"></label>
            <button type="button" id="sell-open-button" class="pure-u-1-5 pure-button button-small"
                    onclick="sellOpen()">卖开
            </button>
            <button type="button" id="sell-close-button" class="pure-u-1-5 pure-button button-small"
                    onclick="sellClose()">卖平
            </button>
          </div>

        </fieldset>

      </form>
    </div>
    <!--      <div v-scope>-->
    <!--        <p v-if="tdData.initOver"> 初始化完成 </p>-->
    <!--        <p v-else="tdData.initOver"> 初始化进行中 </p>-->
    <!--        <input type="checkbox" v-model="tdData.initOver">-->
    <!--        <p> {{ tdData.initOver ? "完成" : "进行中" }} </p>-->
    <!--      </div>-->

  </div>
  <div class="content-lower-log">
    <div id="log-wrapper">
      <table id="log-table" class="pure-table pure-table-bordered">
        <thead>
        <tr>
          <th>日志</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>
<div class="content-foot"></div>

<script src='petite-vue@0.4.1_dist_petite-vue.iife.js'></script>
<script>
  function fTime() {
    let date = new Date();
    let hours = date.getHours();
    let minutes = date.getMinutes();
    let seconds = date.getSeconds();
    return `[ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ] `;
  }

  function log(msg) {
    console.log(fTime(), ...Array.from(arguments));
  }

  const mdData = PetiteVue.reactive({
    quotRows: [],
    isLogin: false,
  })
  const mdApp = PetiteVue.createApp({
    mdData,
  }).mount('#md');

  const tdData = PetiteVue.reactive({
    orders: {},
    orderRows: [],
    trades: {},
    tradeRows: [],
    positions: {},
    positionRows: [],
    instruments: {},
    instrumentRows: [],
    exchanges: {},
    tradingAccount: {},
    isLogin: false,
    curInstrument: {'InstrumentID': '', 'ExchangeID': '', 'Volume': 1, 'Price': 0},
    initOver: false,
    subInstruments: [],
    tdAddr: 'ws://localhost:8080/td/',
    mdAddr: 'ws://localhost:8080/md/',
    investorID: '',
    password: '',
    brokerID: '9999',
    sock_md: '',
    sock_td: '',

    orderInstrumentID: '',
    orderPrice: 0,
    orderVolume: 1,
  })
  const tdApp = PetiteVue.createApp({
    tdData
  }).mount('#td');


  function mdOnopen(event) {
    log('Market channel connected.', tdData.mdAddr);
    showLog('行情通道打开');
    loginMd();
  }

  function mdOnclose(event) {
    log('Market channel closed.');
    mdData.isLogin = false;
    showLog('行情通道关闭');
  }

  function mdOnerror(event) {
    log('Market channel error:', event);
    mdData.isLogin = false;
    showLog('行情通道错误');
  }


  function mdOnmessage(event) {
    let data = JSON.parse(event.data)
    // log('Market msg:', data['MsgType']);
    // console.log(data);
    switch (data['MsgType']) {
      case 'RspUserLogin':
        mdRspUserLogin(data)
        break;
      case 'RspSubMarketData':
        RspSubMarketData(data);
        break;
      case 'RspUnSubMarketData':
        RspUnSubscribeMarketData(data);
        break;
      case 'RtnDepthMarketData':
        RtnDepthMarketData(data);
        break;
    }
  };

  function req_md(data) {
    if (data['MsgType'] !== 'ReqUserLogin' && mdData.isLogin === false) {
      alert('请先登录行情端！');
      return;
    }
    log('Market request:', data['MsgType']);
    // console.log(data);
    tdData.sock_md.send(JSON.stringify(data));
  }

  function parseRspInfo(name, RspInfo) {
    if (RspInfo !== null && RspInfo['ErrorID'] !== 0) {
      console.log(name, 'Fail', RspInfo['ErrorMsg']);
      return false;
    } else {
      // console.log(name, 'Success');
      return true;
    }
  }

  function tdOnopen(event) {
    log('trade channel connected.', tdData.tdAddr);
    showLog('交易通道打开');

    loginTd();
  }

  function tdOnclose(event) {
    log('trade channel closed.');
    tdData.isLogin = false;
    showLog('交易通道关闭');
  }

  function tdOnerror(event) {
    log('trade channel error:', event);
    tdData.isLogin = false;
    showLog('交易通道错误');
  }

  function tdOnmessage(event) {
    let data = JSON.parse(event.data)
    console.log('trade msg:', data['MsgType']);
    // console.log(data);
    switch (data['MsgType']) {
      case 'RspUserLogin':
        tdRspUserLogin(data)
        break;
      case 'RspQryTrade':
        RspQryTrade(data);
        break;
      case 'RspQryInvestorPosition':
        RspQryInvestorPosition(data);
        break;
      case 'RspQryTradingAccount':
        RspQryTradingAccount(data);
        break;
      case 'RspQryInstrument':
        RspQryInstrument(data);
        break;
      case 'RspQryOrder':
        RspQryOrder(data);
        break;
      case 'RspQryExchange':
        RspQryExchange(data);
        break;
      case 'RspOrderInsert':
        RspOrderInsert(data);
        break;
      case 'RspOrderAction':
        RspOrderAction(data);
        break;
      case 'RtnOrder':
        RtnOrder(data);
        break;
      case 'ErrRtnOrderAction':
        ErrRtnOrderAction(data);
        break;
      case 'RtnTrade':
        RtnTrade(data);
        break;
    }
  }

  function req_td(data) {
    if (data['MsgType'] !== 'ReqUserLogin' && tdData.isLogin === false) {
      alert('请先登录交易端！');
      return;
    }
    log('trade request:', data['MsgType']);
    // console.log(data);
    data['RequestID'] = 0;
    tdData.sock_td.send(JSON.stringify(data));
  }


  // 登录
  function login() {
    // 行情通道
    tdData.sock_md = new WebSocket(tdData.mdAddr);
    tdData.sock_md.onopen = mdOnopen;
    tdData.sock_md.onclose = mdOnclose;
    tdData.sock_md.onerror = mdOnerror;
    tdData.sock_md.onmessage = mdOnmessage;

    // 交易通道
    tdData.sock_td = new WebSocket(tdData.tdAddr);
    tdData.sock_td.onopen = tdOnopen;
    tdData.sock_td.onclose = tdOnclose;
    tdData.sock_td.onerror = tdOnerror;
    tdData.sock_td.onmessage = tdOnmessage;
  }


  function loginMd() {
    req_md({"MsgType": "ReqUserLogin", "ReqUserLogin": {"UserID": "", "Password": ""}});
  }

  function mdRspUserLogin(data) {
    if (parseRspInfo('行情登录', data['RspInfo']) === true) {
      mdData.isLogin = true;
      showLog('行情登录成功');
      SubscribeMarketData(['au2412', 'cu2412', 'c2501', 'l2501', 'p2501', 'v2501']);
    } else {
      showLog('行情登录失败');
    }
  }

  function SubscribeMarketData(instruments) {
    // log('订阅行情 ' + instruments);
    req_md({"MsgType": "SubscribeMarketData", "InstrumentID": instruments})
  }

  function RspSubMarketData(data) {
    // console.log(data);
    if (parseRspInfo('行情订阅', data['RspInfo']) === true) {
      tdData.subInstruments.push(data['SpecificInstrument']['InstrumentID']);
    }
  }

  function UnSubscribeMarketData(instruments) {
    req_md({"MsgType": "UnSubscribeMarketData", "InstrumentID": instruments})
  }

  function RspUnSubscribeMarketData(data) {
    console.log(data);
    if (parseRspInfo('取消行情订阅', data['RspInfo']) === true) {
      let instrumentID = data['SpecificInstrument']['InstrumentID'];
      log('退订行情 ' + instrumentID);
      for (let i = 0; i < mdData.quotRows.length; i++) {
        if (mdData.quotRows[i]['InstrumentID'] === instrumentID) {
          mdData.quotRows.splice(i, 1);
          i--;
          break;
        }
      }
    }
  }

  function RtnDepthMarketData(data) {
    let quot = data['DepthMarketData']
    // console.log(data);
    // 匹配交易所
    if (quot.InstrumentID in tdData.instruments) {
      quot.ExchangeID = tdData.instruments[quot.InstrumentID].ExchangeID;
    } else {
      quot.ExchangeID = '';
    }

    // 更新行情
    const index = mdData.quotRows.findIndex(row => row.InstrumentID === quot['InstrumentID']);
    if (index !== -1) {
      for (let key in mdData.quotRows[index]) {
        mdData.quotRows[index][key] = quot[key];
      }
    } else {
      mdData.quotRows.push(quot);
    }
  }

  function loginTd() {
    showLog('交易登录成功');
    req_td({"MsgType": "ReqUserLogin", "ReqUserLogin": {"UserID": tdData.investorID, "Password": tdData.password}});
  }

  // todo 参数有误时，返回 ReqUserLogin MsgType
  function tdRspUserLogin(data) {
    if (parseRspInfo('交易登录', data['RspInfo']) === true) {
      tdData.isLogin = true;
      // console.log(data)
      // 隐藏登录框, 显示报价板
      document.getElementById('login').setAttribute('hidden', '');
      document.getElementById('account-price').removeAttribute('hidden');

      ReqQryTradingAccount();
    } else {
      showLog('交易登录失败');
    }
  }

  function ReqQryTradingAccount() {
    showLog('查询资金...');
    req_td({
      "MsgType": "ReqQryTradingAccount",
      "QryTradingAccount": {
        "BrokerID": tdData.brokerID,
        "InvestorID": tdData.investorID
      },
    });
  }

  function RspQryTradingAccount(data) {
    if (parseRspInfo('查询资金账户', data['RspInfo']) === true) {
      // console.log(data);
      tdData.tradingAccount = data['TradingAccount'];
      if (data['IsLast'] === true) {
        showLog('查询资金成功');

        ReqQryExchange('');
      }
    }
  }

  function ReqQryExchange(exchangeID) {
    showLog('查询交易所...');
    req_td({
      "MsgType": "ReqQryExchange",
      "QryExchange": {
        "ExchangeID": exchangeID
      },
    });
  }

  function RspQryExchange(data) {
    if (parseRspInfo('查询交易所', data['RspInfo']) === true) {
      // console.log(data);
      let exchange = data['Exchange'];
      if (exchange !== null) {
        tdData.exchanges[exchange['ExchangeID']] = exchange;
      }
      if (data['IsLast'] === true) {
        showLog('查询交易所成功');

        ReqQryOrder('');
      }
    }

  }

  async function ReqQryInstrument(exchangeID, productID, instrumentID) {
    await sleep(1000);
    showLog('查询合约...');
    req_td({
      "MsgType": "ReqQryInstrument",
      "QryInstrument": {
        "ExchangeID": exchangeID,
        "InstrumentID": instrumentID,
        "ProductID": productID
      },
    });
  }

  function RspQryInstrument(data) {
    if (parseRspInfo('查询合约', data['RspInfo']) === true) {
      // console.log(data);
      let instrument = data['Instrument'];
      if (instrument !== null) {
        // 过滤期货合约
        if (instrument['InstrumentID'] !== null && instrument['ProductClass'] === '1') {
          instrument.ExchangeName = tdData.exchanges[instrument.ExchangeID].ExchangeName;
          tdData.instruments[instrument.InstrumentID] = instrument;
          tdData.instrumentRows.push(instrument);
        }
      }
      if (data['IsLast'] === true) {
        showLog('查询合约成功');
        showLog('初始化完成');
        tdData.initOver = true;
      }
    }
  }

  function ReqQryOrder(instrumentID) {
    showLog('查询订单...');
    req_td({
      "MsgType": "ReqQryOrder",
      "QryOrder": {
        "InvestorID": tdData.investorID,
        "InstrumentID": instrumentID,
      },
    });
  }


  function RspQryOrder(data) {
    if (parseRspInfo('查询报单', data['RspInfo']) === true) {
      // console.log(data);
      let order = data['Order'];
      if (order !== null) {
        order.StatusMsg = orderStatus(order.OrderStatus);
        order.bs = buySell(order.Direction);
        order.oc = openClose(order.CombOffsetFlag);
        let key = orderKey(order);
        tdData.orders[key] = order;
      }
      if (data['IsLast'] === true) {
        showLog('查询订单成功');
        // todo
        tdData.orderRows = Object.values(tdData.orders);

        // 初始化流程
        if (tdData.initOver === false) {
          ReqQryTrade('');
        }
      }
    }
  }

  function ReqQryTrade(exchangeID) {
    showLog('查询成交...');
    req_td({
      "MsgType": "ReqQryTrade",
      "QryTrade": {
        "BrokerID": tdData.brokerID,
        "InvestorID": tdData.investorID,
        "ExchangeID": exchangeID
      },
    });
  }

  function RspQryTrade(data) {
    if (parseRspInfo('查询成交', data['RspInfo']) === true) {
      // console.log(data);
      let trade = data['Trade'];
      if (trade !== null) {
        trade.bs = buySell(trade.Direction);
        trade.oc = openClose(trade.OffsetFlag);
        let key = trade['ExchangeID'] + '.' + trade['TradeID'] + '.' + trade['OrderSysID'];
        tdData.trades[key] = trade;
      }

      if (data['IsLast'] === true) {
        showLog('查询成交成功');
        // todo
        tdData.tradeRows = Object.values(tdData.trades);

        // 初始化流程
        if (tdData.initOver === false) {
          ReqQryInvestorPosition('');
        }
      }
    }
  }

  function ReqQryInvestorPosition(exchangeID) {
    showLog('查询持仓...');
    req_td({
      "MsgType": "ReqQryInvestorPosition",
      "QryInvestorPosition": {
        "BrokerID": "9999",
        "InvestorID": tdData.investorID,
        "ExchangeID": exchangeID
      },
    });

  }

  function RspQryInvestorPosition(data) {
    if (parseRspInfo('查询持仓', data['RspInfo']) === true) {
      // console.log(data);
      let position = data['InvestorPosition'];
      if (position !== null) {
        position.sl = shortLong(position.PosiDirection);
        let exist = false;
        let key = position.InstrumentID + '.' + position.PosiDirection;
        for (let i = 0; i < tdData.positionRows.length; i++) {
          let key1 = tdData.positionRows[i].InstrumentID + '.' + tdData.positionRows[i].PosiDirection;
          if (key === key1) {
            exist = true;
            // 更新持仓
            for (let key3 in tdData.positionRows[i]) {
              tdData.positionRows[i][key3] = position[key3];
            }
            break;
          }
        }

        // 新持仓
        if (exist === false) {
          tdData.positionRows.push(position);
        }

        // 订阅持仓合约
        if (position.InstrumentID in tdData.subInstruments) {

        } else {
          SubscribeMarketData([position.InstrumentID]);
        }
      }
      if (data['IsLast'] === true) {
        showLog('查询持仓成功');

        // 初始化流程
        if (tdData.initOver === false) {
          ReqQryInstrument('', '', '');
        }
      }
    }
  }

  function ReqOrderInsert(direction, combOffset) {
    // 限价单
    req_td({
      "MsgType": "ReqOrderInsert",
      "InputOrder": {
        "BrokerID": tdData.brokerID,
        "InvestorID": tdData.investorID,
        "ExchangeID": tdData.curInstrument.ExchangeID,
        "InstrumentID": tdData.curInstrument.InstrumentID,
        "LimitPrice": tdData.curInstrument.Price,
        "OrderPriceType": "2",
        "Direction": direction,
        "CombOffsetFlag": combOffset,
        "CombHedgeFlag": "1",
        "VolumeTotalOriginal": tdData.curInstrument.Volume,
        "TimeCondition": "3",
        "VolumeCondition": "1",
        "ContingentCondition": "1",
        "ForceCloseReason": "0",
        "IsAutoSuspend": 0,
        "IsSwapOrder": 0
      }
    });
  }

  function RspOrderInsert(data) {
    if (parseRspInfo('订单录入', data['RspInfo']) === true) {
      console.log(data);
    }
  }

  function ReqOrderAction(exchangeID, instrumentID, orderSysID) {
    req_td({
      "MsgType": "ReqOrderAction",
      "InputOrderAction": {
        "BrokerID": tdData.brokerID,
        "InvestorID": tdData.investorID,
        "UserID": tdData.investorID,
        "ExchangeID": exchangeID,
        "InstrumentID": instrumentID,
        "ActionFlag": "0",
        "OrderSysID": orderSysID
      }
    });
  }

  function RspOrderAction(data) {
    if (parseRspInfo('订单撤销', data['RspInfo']) === true) {
    }
  }

  function orderKey(order) {
    return order.InstrumentID + '.' + order.OrderSysID + '.' + order.OrderLocalID;
  }

  function RtnOrder(data) {
    // console.log(data);
    let order = data['Order'];
    if (order === null) {
      return;
    }

    order.StatusMsg = orderStatus(order.OrderStatus);
    order.oc = openClose(order.CombOffsetFlag);
    order.bs = buySell(order.Direction);
    // 更新订单
    // 全部成交、部分成交、未成交、撤单
    if (order.OrderStatus === '0' || order.OrderStatus === '1' || order.OrderStatus === '3' || order.OrderStatus === '5') {
      let key1 = orderKey(order);
      tdData.orders[key1] = order;

      let exist = false;
      for (let i = 0; i < tdData.orderRows.length; i++) {
        let key2 = orderKey(tdData.orderRows[i]);
        if (key1 === key2) {
          exist = true;
          for (let key3 in tdData.orderRows[i]) {
            tdData.orderRows[i][key3] = order[key3];
          }
          break;
        }
      }
      // 新订单
      if (exist === false) {
        tdData.orderRows.push(order);
      }
    }
  }

  function ErrRtnOrderAction() {

  }

  function RtnTrade(data) {
    // console.log(data);
    let trade = data['Trade'];
    if (trade !== null) {
      trade.bs = buySell(trade.Direction);
      trade.oc = openClose(trade.OffsetFlag);
      let key = trade['ExchangeID'] + '.' + trade['TradeID'] + '.' + trade['OrderSysID'];
      tdData.trades[key] = trade;
      tdData.tradeRows.push(trade);

      // 查询持仓
      ReqQryInvestorPosition('');
      // todo 查询其他
    }
  }

  // 定义打开tab页的函数
  function openTab(evt, tabName) {
    let i, pureTabContent, pureTabButton;

    // 隐藏所有tab内容，并设置为不影响布局的样式
    pureTabContent = document.getElementsByClassName("pure-tab-content");
    for (i = 0; i < pureTabContent.length; i++) {
      pureTabContent[i].style.display = "none";
      pureTabContent[i].style.visibility = "hidden";
      pureTabContent[i].style.opacity = "0";
    }

    // 移除所有tab按钮的激活状态
    pureTabButton = document.getElementsByClassName("pure-tab-button");
    for (i = 0; i < pureTabButton.length; i++) {
      pureTabButton[i].style.backgroundColor = "#f1f1f1";
      pureTabButton[i].classList.remove("active");
    }

    // 显示当前选中的tab内容并设置为正常显示和交互的样式
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName).style.visibility = "visible";
    document.getElementById(tabName).style.opacity = "1";

    // 设置当前tab按钮为激活状态
    evt.currentTarget.style.backgroundColor = "#ccc";
    evt.currentTarget.classList.add("active");
  }

  // 打开默认tab页
  document.getElementById("defaultOpen").click();

  // 创建一个返回Promise的函数来模拟sleep
  const sleep = (ms) => {
    return new Promise((resolve) => {
      setTimeout(resolve, ms);
    });
  };

  function orderStatus(status) {
    if (status === '0') {
      return '全部成交';
    } else if (status === '1') {
      return '部分成交';
    } else if (status === '3') {
      return '未成交';
    } else if (status === '5') {
      return '已撤单';
    }
  }

  function openClose(flag) {
    if (flag === '0') {
      return '开';
    } else if (flag === '1') {
      return '平';
    } else if (flag === '2') {
      return '强平';
    } else if (flag === '3') {
      return '平今';
    } else if (flag === '4') {
      return '平昨';
    }
  }

  function buySell(flag) {
    if (flag === '0') {
      return '买';
    } else if (flag === '1') {
      return '卖';
    }
  }

  function shortLong(flag) {
    if (flag === '1') {
      return '净';
    } else if (flag === '2') {
      return '多';
    } else if (flag === '3') {
      return '空';
    }
  }


  function sub(button) {
    // 订阅行情
    let row = button.closest('tr');
    let instrument = row.querySelector('td:nth-child(2)').textContent;
    SubscribeMarketData([instrument]);
  }

  function unsub(button) {
    // 退订行情
    let row = button.closest('tr');
    let instrumentID = row.querySelector('td:nth-child(2)').textContent;
    UnSubscribeMarketData([instrumentID]);
  }

  function cancelOrder(button) {
    // 撤单
    let row = button.closest('tr');
    let instrumentID = row.querySelector('td:nth-child(2)').textContent;
    let orderSysID = row.querySelector('td:nth-child(8)').textContent;
    let exchangeID = row.querySelector('td:nth-child(11)').textContent;

    ReqOrderAction(exchangeID, instrumentID, orderSysID);
  }

  function quotSelect(row) {
    // 行情表点击
    let allRows = document.getElementById('futures-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');

    // 报价板设置当前合约
    let instrument = row.querySelector('td:nth-child(2)').textContent;
    for (let i = 0; i < mdData.quotRows.length; i++) {
      if (mdData.quotRows[i]['InstrumentID'] === instrument) {
        tdData.curInstrument.Price = mdData.quotRows[i].LastPrice;
        tdData.curInstrument.InstrumentID = instrument;
        tdData.curInstrument.ExchangeID = mdData.quotRows[i].ExchangeID;
        // todo 重新按照最小变动价位设置 input 跳动单位
        break;
      }
    }
  }

  function orderSelect(row) {
    // 订单表点击
    let allRows = document.getElementById('order-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function tradeSelect(row) {
    // 成交表点击
    let allRows = document.getElementById('trade-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function posiSelect(row) {
    // 持仓表点击
    let allRows = document.getElementById('posi-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function instrSelect(row) {
    // 合约表点击
    let allRows = document.getElementById('instr-table').querySelectorAll('tr');
    allRows.forEach(function (otherRow) {
      otherRow.classList.remove('selected');
    });
    row.classList.add('selected');
  }

  function buyOpen() {
    // 买开
    ReqOrderInsert('0', '0');
  }

  function buyClose() {
    // 买平
    ReqOrderInsert('0', '1');
  }

  function sellOpen() {
    // 卖开
    ReqOrderInsert('1', '0');
  }

  function sellClose() {
    // 卖平
    ReqOrderInsert('1', '1');
  }

  function showLog(msg) {
    let row = document.createElement('tr');
    let cell = document.createElement('td');
    cell.style.textAlign = 'left';
    cell.style.padding = '5px';
    cell.textContent = fTime() + msg;
    row.appendChild(cell);
    document.getElementById('log-table').appendChild(row);
  }

</script>
</body>

</html>